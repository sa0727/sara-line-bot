// paid_engine.js
const { PaidPhase } = require("./paid_state");

function trimHistory(history, maxTurns = 12) {
  const h = Array.isArray(history) ? history : [];
  const maxMessages = maxTurns * 2;
  return h.length > maxMessages ? h.slice(-maxMessages) : h;
}

// ã€Œã€å†…ã®æœ€å¾Œã‚’æ‹¾ã†ï¼ˆevalç”¨ï¼‰
function extractQuotedMessage(text) {
  if (!text) return null;
  const matches = [...String(text).matchAll(/ã€Œ([^ã€]{1,160})ã€/g)];
  if (!matches.length) return null;
  return matches[matches.length - 1][1].trim();
}

async function generatePaidChatSara({
  openai,
  answers,
  history,
  userText,
  paidSummary = null,
  paidMeta = null,
}) {
  const systemPrompt = `
ã‚ãªãŸã¯æ‹æ„›ç›¸è«‡ã®â€œãŠã­ãˆâ€ã€Œã‚µãƒ©ã€ã€‚
å£èª¿ã¯ä¸€è²«ã—ã¦ï¼šå¼·ã‚ãƒ»è‰²æ°—ãƒ»å„ªã—ã•ãƒ»çŸ­ãåˆºã™ã€‚ä¸Šã‹ã‚‰ç›®ç·šã¯OKã ãŒã€äººæ ¼å¦å®šã‚„æ”»æ’ƒã¯ã—ãªã„ã€‚
ä¸‹å“ãƒ»å·®åˆ¥ãƒ»è„…ã—ãƒ»éæ¿€ãªè¨€è‘‰ã¯ç¦æ­¢ã€‚ç›¸æ‰‹ã‚’è²¬ã‚ã‚‹/è©°ã‚ã‚‹/ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹èª˜å°ã‚‚ã—ãªã„ã€‚

ã€çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ï¼ˆè¦‹ãŸç›®ï¼‰ã€‘
- æ©Ÿæ¢°çš„ãªè¦‹å‡ºã—ï¼ˆã€åˆ¤æ–­ã€‘ãªã©ï¼‰ã‚’ä¸€åˆ‡ä½¿ã‚ãªã„
- ã€Œçµè«–ï¼šã€ã‚‚ä½¿ã‚ãªã„
- LINEã§èª­ã¿ã‚„ã™ãï¼šçŸ­ã„æ®µè½ã€æ”¹è¡Œå¤šã‚ã€‚1æ®µè½ã¯1ã€œ2æ–‡
- ç®‡æ¡æ›¸ãã¯æœ€å¤§3è¡Œã¾ã§ï¼ˆä½¿ã†ãªã‚‰çµ‚ç›¤ã ã‘ï¼‰
- æ–‡é¢ã‚’å‡ºã™æ™‚ã¯å¿…ãšã€Œã€ã§ã‚³ãƒ”ãƒšã§ãã‚‹å½¢ã«ã™ã‚‹ï¼ˆ1ã€œ2æ–‡ã€é•·æ–‡ç¦æ­¢ï¼‰
- è¿·ã‚ã›ãªã„ï¼šåŸºæœ¬ã¯ææ¡ˆ1ã¤ã€‚ã©ã†ã—ã¦ã‚‚å¿…è¦ãªã‚‰2æ¡ˆã¾ã§

ã€çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ï¼ˆä¸­èº«ï¼‰ã€‘
è¿”ç­”ã®å‰ã«ã€é ­ã®ä¸­ã§å¿…ãšã“ã‚Œã‚’ç¢ºå®šã—ã¦ã‹ã‚‰æ–‡ç« åŒ–ï¼š
1) ä»Šã¯ã€Œé€ã‚‹/å¾…ã¤/ç¢ºèª/æ§˜å­è¦‹ã€
2) ãƒ™ã‚¹ãƒˆãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆä»Šæ—¥/æ˜æ—¥/2æ—¥å¾Œ + æ™‚é–“å¸¯ï¼‰
3) é€ã‚‹ãªã‚‰æ–‡é¢ï¼ˆ1ã€œ2æ–‡ï¼‰
4) ã‚„ã£ã¡ã‚ƒãƒ€ãƒ¡ï¼ˆæœ€å¤§3ã¤ï¼‰
â€»ãƒ©ãƒ™ãƒ«ã¯ä½¿ã‚ãšã€ä¼šè©±ã¨ã—ã¦è‡ªç„¶ã«åŸ‹ã‚è¾¼ã‚€

ã€ç¦æ­¢ï¼ˆé‡è¦ï¼‰ã€‘
- ç›¸æ‰‹ã«é€ã‚‹æ–‡é¢ã«ã€Œã©ã£ã¡ã€ã€Œã©ã¡ã‚‰ã€ã‚’å…¥ã‚Œãªã„ï¼ˆé¸ã°ã›ã‚‹åœ§ã«ãªã‚‹ï¼‰
  æ—¥ç¨‹ææ¡ˆã¯ã€Œâ—‹æ—¥ã‹â—‹æ—¥ã‚ãŸã‚Šç©ºã„ã¦ãŸã‚‰å¬‰ã—ã„ã€‚éƒ½åˆã„ã„æ—¥ã‚ã‚Œã°æ•™ãˆã¦ã€ã®å½¢ã«è¨€ã„æ›ãˆã‚‹
- ã€Œãªã‚“ã§è¿”äº‹ãã‚Œãªã„ã®ï¼Ÿã€ã€Œæ—¢èª­ãªã®ã«ã€ãªã©è©°ã‚ã‚‹æ–‡é¢ã¯ç¦æ­¢

ã€æ›–æ˜§ã•ã®å‡¦ç†ï¼ˆè¶…é‡è¦ï¼‰ã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œé€ã£ã¦ã„ã„ï¼Ÿã€ã€Œã‚³ãƒ”ãƒšã§ã„ã„ï¼Ÿã€ã€Œã‚¹ã‚¯ã‚·ãƒ§ã§ã„ã„ï¼Ÿã€ã¯ã€
(1) ã‚µãƒ©ï¼ˆã“ã®ãƒãƒ£ãƒƒãƒˆï¼‰ã«é€ã‚‹è©±ãªã®ã‹ã€(2) ç›¸æ‰‹ã«é€ã‚‹LINEæ–‡ã®è©±ãªã®ã‹ã€
å¿…ãšæ–‡è„ˆã§åˆ¤å®šã™ã‚‹ã€‚
åˆ¤å®šã§ããªã„å ´åˆã¯ã€æœ€åˆã«ç¢ºèªè³ªå•ã‚’1ã¤ã ã‘ã™ã‚‹ï¼š
ä¾‹ï¼šã€Œãã‚Œã€ã‚ãŸã—ï¼ˆã‚µãƒ©ï¼‰ã«é€ã‚‹ï¼Ÿãã‚Œã¨ã‚‚ç›¸æ‰‹ã«é€ã‚‹æ–‡é¢ã®è©±ï¼Ÿã€
â€»ã“ã®ç¢ºèªä»¥å¤–ã§ã€Œã©ã£ã¡ãŒã„ã„ï¼Ÿã€ã¨é¸ã°ã›ã‚‹ã®ã¯ç¦æ­¢ã€‚

ã€å›ç­”ã®å‹ï¼ˆä¼šè©±ã¨ã—ã¦ã“ã®é †ï¼‰ã€‘
- ã¾ãšç›¸æ§Œï¼‹ä¸€è¨€ã§æ–¹é‡ï¼ˆé€ã‚‹/å¾…ã¤/ç¢ºèª/æ§˜å­è¦‹ï¼‰
- ç†ç”±ã‚’1ã€œ2æ–‡
- å…·ä½“ï¼šã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å…·ä½“çš„ã«ã€‚å¿…è¦ãªã‚‰é€ä¿¡æ–‡ã‚’ã€Œã€ã§æç¤º
- å¿…è¦ãªå ´åˆã ã‘NGã‚’æœ€å¤§3ã¤
- æœ€å¾Œã«ã‚µãƒ©ã®ä¸€è¨€ã§ç· ã‚ã‚‹ï¼ˆğŸ’‹ï¼‰
`.trim();

  const a = answers || {};
  const safe = (v, fallback = "ä¸æ˜") =>
    v == null || String(v).trim() === "" ? fallback : String(v).trim();

  const h = Array.isArray(history) ? history : [];
  const recent = h.slice(-6);
  const recentText = recent
    .map((m) => `${m.role === "user" ? "ãƒ¦ãƒ¼ã‚¶ãƒ¼" : "ã‚µãƒ©"}: ${m.content}`)
    .join("\n");

  const meta = paidMeta || {};
  const phase = meta.phase || PaidPhase.UNKNOWN;

  const contextPrompt = `
${paidSummary ? `ã€é•·æœŸãƒ¡ãƒ¢ï¼ˆæœ€å„ªå…ˆã§å®ˆã‚‹ï¼‰ã€‘\n${paidSummary}\n` : ""}

ã€å›ºå®šæƒ…å ±ã€‘
ãƒ»æ‚©ã¿ï¼š${safe(a.problem)}
ãƒ»æœ€å¾Œã«ä¼šã£ãŸ/æœªå¯¾é¢ï¼š${safe(a.lastMet)}
ãƒ»æœ€å¾Œã«é€ã£ãŸã®ã¯ï¼š${safe(a.lastSender)}
ãƒ»æ²ˆé»™ï¼š${safe(a.silence)}
ãƒ»ã‚´ãƒ¼ãƒ«ï¼š${safe(a.goal)}
ãƒ»æ€–ã„ã“ã¨ï¼š${safe(a.fear)}

ã€é–¢ä¿‚æ€§ã€‘
ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¸ï¼š${safe(a.relationshipStage)}
ãƒ»ç›¸æ‰‹ãƒšãƒ¼ã‚¹ï¼š${safe(a.partnerSpeed)}
ãƒ»ç›¸æ‰‹ã‚¿ã‚¤ãƒ—ï¼š${safe(a.partnerType)}

ã€é‹ç”¨ãƒ¡ã‚¿ã€‘
ãƒ»ãƒ•ã‚§ãƒ¼ã‚ºï¼š${phase}
ãƒ»ç›´è¿‘ã®ææ¡ˆæ–‡ï¼š${meta.lastSentText || "ï¼ˆãªã—ï¼‰"}

${meta.hardRules || ""}
${meta.patterns || ""}
${meta.temperatureGuidance || ""}

ã€ç›´è¿‘ä¼šè©±ï¼ˆè¦ç‚¹ï¼‰ã€‘
${recentText || "ï¼ˆã¾ã å°‘ãªã„ï¼‰"}

ã€ä»Šå›ã®ç›¸è«‡ã€‘
${userText}
`.trim();

  const clipped = trimHistory(h, 12);

  const response = await openai.responses.create({
    model: "gpt-4.1-mini",
    input: [
      { role: "system", content: systemPrompt },
      { role: "user", content: contextPrompt },
      ...clipped,
    ],
    max_output_tokens: 800,
  });

  const out = (response.output_text || "").trim();
  return out.replace(/\n{3,}/g, "\n\n") || "ã†ã¾ãèª­ã‚ãªã‹ã£ãŸã‚ã€‚ã‚‚ã†ä¸€å›é€ã£ã¦ğŸ’‹";
}

module.exports = {
  trimHistory,
  extractQuotedMessage,
  generatePaidChatSara,
};
